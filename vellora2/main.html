<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vellora boutique</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        body { font-family: 'Tajawal', sans-serif; }
        .invoice-header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .section { transition: all 0.3s ease; }
        .active-tab { background-color: #1d4ed8 !important; }
        .discount-badge {
            background-color: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 12px;
            margin-right: 4px;
        }
        .invoice-watermark {
            position: absolute;
            opacity: 0.1;
            font-size: 15rem;
            font-weight: bold;
            color: #1e40af;
            z-index: -1;
        }
        .invoice-table th {
            background-color: #f3f4f6;
            font-weight: 700;
            padding: 0.75rem;
        }
        .invoice-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .invoice-totals {
            background-color: #f9fafb;
            border-radius: 0.5rem;
        }
        .stamp {
            position: absolute;
            opacity: 0.8;
            transform: rotate(15deg);
        }
        .signature-line {
            width: 200px;
            border-top: 1px solid #111827;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <header class="bg-white shadow-lg rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-blue-600">نظام الفواتير المبسط</h1>
                    <p class="text-gray-600">إدارة الفواتير والمخزون</p>
                </div>
                <div class="flex items-center space-x-2 space-x-reverse">
                    <span id="currentDate" class="text-gray-700"></span>
                    <i class="fas fa-calendar-alt text-blue-500"></i>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- Tabs -->
            <div class="flex border-b">
                <button onclick="showSection('invoices')" id="invoicesTab" class="flex-1 py-4 px-6 text-center font-bold text-blue-600 border-b-2 border-blue-600 active-tab">
                    <i class="fas fa-file-invoice mr-2"></i> الفواتير
                </button>
                <button onclick="showSection('products')" id="productsTab" class="flex-1 py-4 px-6 text-center font-bold text-gray-600 hover:text-blue-600">
                    <i class="fas fa-boxes mr-2"></i> المخزون
                </button>
                <button onclick="showSection('reports')" id="reportsTab" class="flex-1 py-4 px-6 text-center font-bold text-gray-600 hover:text-blue-600">
                    <i class="fas fa-chart-bar mr-2"></i> التقارير
                </button>
            </div>

            <!-- Invoices Section -->
            <div id="invoices" class="section p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Create Invoice Form -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h2 class="text-2xl font-bold mb-4 text-blue-600 border-b pb-2">
                            <i class="fas fa-plus-circle mr-2"></i>إنشاء فاتورة جديدة
                        </h2>
                        <form id="invoiceForm" class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2 font-medium">اسم العميل</label>
                                <input type="text" id="customerName" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2 font-medium">تاريخ الفاتورة</label>
                                <input type="date" id="invoiceDate" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2 font-medium">ملاحظات</label>
                                <textarea id="invoiceNotes" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2"></textarea>
                            </div>
                            
                            <h3 class="text-lg font-bold mt-4 mb-2">أصناف الفاتورة</h3>
                            <div id="invoiceItems" class="space-y-4">
                                <div class="grid grid-cols-12 gap-2 items-end">
                                    <div class="col-span-5">
                                        <label class="block text-gray-700 mb-2 text-sm">المنتج</label>
                                        <select class="item-product w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">اختر منتجاً</option>
                                        </select>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-gray-700 mb-2 text-sm">الكمية</label>
                                        <input type="number" class="item-quantity w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" min="1" value="1">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-gray-700 mb-2 text-sm">السعر</label>
                                        <input type="number" class="item-price w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" min="0" step="0.01" readonly>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-gray-700 mb-2 text-sm">الخصم %</label>
                                        <input type="number" class="item-discount w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" min="0" max="100" value="0">
                                    </div>
                                    <div class="col-span-1">
                                        <button type="button" onclick="addInvoiceItem()" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 p-4 rounded-lg mt-4">
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-700">المجموع قبل الخصم:</span>
                                    <span id="subtotalAmount">0.00 دج</span>
                                </div>
                                <div class="flex justify-between mb-2 text-red-600">
                                    <span class="text-gray-700">إجمالي الخصم:</span>
                                    <span id="totalDiscountAmount">0.00 دج</span>
                                </div>
                                <div class="flex justify-between font-bold text-lg border-t pt-2">
                                    <span class="text-gray-700">المبلغ الإجمالي:</span>
                                    <span id="grandTotalAmount">0.00 دج</span>
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 mt-4">
                                <i class="fas fa-save mr-2"></i>حفظ الفاتورة
                            </button>
                        </form>
                    </div>
                    
                    <!-- Invoices List -->
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-blue-600 border-b pb-2">
                            <i class="fas fa-list mr-2"></i>سجل الفواتير
                        </h2>
                        <div class="mb-4">
                            <input type="text" id="invoiceSearch" placeholder="ابحث عن فاتورة..." class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="p-3 text-right font-bold text-gray-700">#</th>
                                        <th class="p-3 text-right font-bold text-gray-700">العميل</th>
                                        <th class="p-3 text-right font-bold text-gray-700">المبلغ</th>
                                        <th class="p-3 text-right font-bold text-gray-700">التاريخ</th>
                                        <th class="p-3 text-right font-bold text-gray-700">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="invoicesTable" class="divide-y divide-gray-200">
                                    <!-- Dynamic content will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div id="products" class="section hidden p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Add Product Form -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h2 class="text-2xl font-bold mb-4 text-blue-600 border-b pb-2">
                            <i class="fas fa-plus-circle mr-2"></i>إضافة منتج جديد
                        </h2>
                        <form id="productForm" class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2 font-medium">اسم المنتج</label>
                                <input type="text" id="productName" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-2 font-medium">السعر (دج)</label>
                                    <input type="number" id="productPrice" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" min="0" step="0.01" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2 font-medium">الكمية المتاحة</label>
                                    <input type="number" id="productQuantity" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" min="0" required>
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                                <i class="fas fa-save mr-2"></i>حفظ المنتج
                            </button>
                        </form>
                    </div>
                    
                    <!-- Products List -->
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-blue-600 border-b pb-2">
                            <i class="fas fa-boxes mr-2"></i>قائمة المنتجات
                        </h2>
                        <div class="mb-4">
                            <input type="text" id="productSearch" placeholder="ابحث عن منتج..." class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="p-3 text-right font-bold text-gray-700">المنتج</th>
                                        <th class="p-3 text-right font-bold text-gray-700">السعر</th>
                                        <th class="p-3 text-right font-bold text-gray-700">المخزون</th>
                                        <th class="p-3 text-right font-bold text-gray-700">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTable" class="divide-y divide-gray-200">
                                    <!-- Dynamic content will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports" class="section hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-blue-600 border-b pb-2">
                    <i class="fas fa-chart-pie mr-2"></i>التقارير والإحصائيات
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- Sales Summary -->
                    <div class="bg-white border border-blue-100 rounded-lg shadow-sm p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500">إجمالي المبيعات</p>
                                <h3 class="text-3xl font-bold text-blue-600" id="totalSales">0 دج</h3>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i class="fas fa-receipt text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Invoices Summary -->
                    <div class="bg-white border border-purple-100 rounded-lg shadow-sm p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500">عدد الفواتير</p>
                                <h3 class="text-3xl font-bold text-purple-600" id="totalInvoices">0</h3>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-full">
                                <i class="fas fa-file-invoice text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Products Summary -->
                    <div class="bg-white border border-green-100 rounded-lg shadow-sm p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500">عدد المنتجات</p>
                                <h3 class="text-3xl font-bold text-green-600" id="totalProducts">0</h3>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full">
                                <i class="fas fa-box text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Invoices -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-history mr-2"></i>أحدث الفواتير
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="p-3 text-right font-bold text-gray-700">#</th>
                                    <th class="p-3 text-right font-bold text-gray-700">العميل</th>
                                    <th class="p-3 text-right font-bold text-gray-700">المبلغ</th>
                                    <th class="p-3 text-right font-bold text-gray-700">التاريخ</th>
                                </tr>
                            </thead>
                            <tbody id="recentInvoices" class="divide-y divide-gray-200">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-auto">
            <div class="flex justify-between items-center border-b p-4 sticky top-0 bg-white z-10">
                <h3 class="text-xl font-bold text-gray-800">تفاصيل الفاتورة #<span id="modalInvoiceId"></span></h3>
                <div>
                    <button onclick="printInvoice()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mr-2">
                        <i class="fas fa-print mr-2"></i>طباعة
                    </button>
                    <button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        إغلاق
                    </button>
                </div>
            </div>
            <div class="p-6" id="invoiceDetails">
                <!-- Invoice details will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center border-b p-4">
                <h3 class="text-xl font-bold text-gray-800">تفاصيل المنتج</h3>
                <button onclick="closeProductModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6" id="productDetails">
                <!-- Product details will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // البيانات التمهيدية
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        let currentInvoiceItems = [];
        let currentInvoiceId = null;
        
        // تهيئة النظام عند التحميل
        document.addEventListener('DOMContentLoaded', function() {
            // عرض التاريخ الحالي
            const today = new Date().toLocaleDateString('ar-DZ', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('currentDate').textContent = today;
            
            // تعيين تاريخ اليوم كتاريخ افتراضي للفاتورة
            document.getElementById('invoiceDate').valueAsDate = new Date();
            
            // تحميل البيانات
            loadProducts();
            loadInvoices();
            updateReports();
            
            // عرض قسم الفواتير افتراضيًا
            showSection('invoices');
            
            // إعداد مستمعي الأحداث
            setupEventListeners();
        });
        
        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // البحث عن الفواتير
            document.getElementById('invoiceSearch').addEventListener('input', function() {
                filterInvoices();
            });
            
            // البحث عن المنتجات
            document.getElementById('productSearch').addEventListener('input', function() {
                filterProducts();
            });
            
            // تحديث سعر المنتج عند الاختيار
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('item-product')) {
                    const productId = e.target.value;
                    if (productId && products[productId]) {
                        const product = products[productId];
                        const row = e.target.closest('.grid');
                        row.querySelector('.item-price').value = product.price.toFixed(2);
                        calculateInvoiceTotals();
                    }
                }
                
                // تحديث الكميات والخصومات
                if (e.target.classList.contains('item-quantity') || 
                    e.target.classList.contains('item-discount')) {
                    calculateInvoiceTotals();
                }
            });
            
            // إضافة منتج جديد
            document.getElementById('productForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addProduct();
            });
            
            // إنشاء فاتورة جديدة
            document.getElementById('invoiceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createInvoice();
            });
        }
        
        // تحميل المنتجات
        function loadProducts() {
            const productSelects = document.querySelectorAll('.item-product');
            const productsTable = document.getElementById('productsTable');
            
            // مسح الخيارات الحالية
            productSelects.forEach(select => {
                select.innerHTML = '<option value="">اختر منتجاً</option>';
            });
            productsTable.innerHTML = '';
            
            // إضافة المنتجات إلى القوائم المنسدلة وجدول المنتجات
            products.forEach((product, index) => {
                // إضافة إلى القوائم المنسدلة
                productSelects.forEach(select => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${product.name} - ${product.price.toFixed(2)} دج`;
                    select.appendChild(option);
                });
                
                // إضافة إلى جدول المنتجات
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3">${product.name}</td>
                    <td class="p-3">${product.price.toFixed(2)} دج</td>
                    <td class="p-3">${product.quantity}</td>
                    <td class="p-3">
                        <button onclick="viewProduct(${index})" class="text-blue-500 hover:text-blue-700 mr-2">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="editProduct(${index})" class="text-yellow-500 hover:text-yellow-700 mr-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteProduct(${index})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                productsTable.appendChild(row);
            });
        }
        
        // تحميل الفواتير
        function loadInvoices() {
            const invoicesTable = document.getElementById('invoicesTable');
            const recentInvoices = document.getElementById('recentInvoices');
            
            // مسح الجداول الحالية
            invoicesTable.innerHTML = '';
            recentInvoices.innerHTML = '';
            
            // إضافة الفواتير إلى الجدول الرئيسي
            invoices.forEach((invoice, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="p-3">${invoice.id}</td>
                    <td class="p-3">${invoice.customerName}</td>
                    <td class="p-3">${invoice.totalAfterDiscount.toFixed(2)} دج</td>
                    <td class="p-3">${invoice.issueDate.split(',')[0]}</td>
                    <td class="p-3">
                        <button onclick="viewInvoice(${index})" class="text-blue-500 hover:text-blue-700 mr-2">
                            <i class="fas fa-eye"></i> عرض
                        </button>
                    </td>
                `;
                invoicesTable.appendChild(row);
            });
            
            // إضافة أحدث 5 فواتير إلى قسم التقارير
            const recent = invoices.slice(0, 5);
            recent.forEach(invoice => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3">${invoice.id}</td>
                    <td class="p-3">${invoice.customerName}</td>
                    <td class="p-3">${invoice.totalAfterDiscount.toFixed(2)} دج</td>
                    <td class="p-3">${invoice.issueDate.split(',')[0]}</td>
                `;
                recentInvoices.appendChild(row);
            });
        }
        
        // تصفية الفواتير
        function filterInvoices() {
            const searchTerm = document.getElementById('invoiceSearch').value.toLowerCase();
            const rows = document.getElementById('invoicesTable').querySelectorAll('tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const shouldShow = searchTerm === '' || 
                    Array.from(cells).some(cell => cell.textContent.toLowerCase().includes(searchTerm));
                
                row.style.display = shouldShow ? '' : 'none';
            });
        }
        
        // تصفية المنتجات
        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const rows = document.getElementById('productsTable').querySelectorAll('tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const shouldShow = searchTerm === '' || 
                    Array.from(cells).some(cell => cell.textContent.toLowerCase().includes(searchTerm));
                
                row.style.display = shouldShow ? '' : 'none';
            });
        }
        
        // تحديث التقارير
        function updateReports() {
            // إجمالي المبيعات
            const totalSales = invoices.reduce((sum, invoice) => sum + invoice.totalAfterDiscount, 0);
            document.getElementById('totalSales').textContent = totalSales.toFixed(2) + ' دج';
            
            // عدد الفواتير
            document.getElementById('totalInvoices').textContent = invoices.length;
            
            // عدد المنتجات
            document.getElementById('totalProducts').textContent = products.length;
        }
        
        // إضافة صنف إلى الفاتورة
        function addInvoiceItem() {
            const itemRow = document.querySelector('#invoiceItems .grid');
            const productIndex = itemRow.querySelector('.item-product').value;
            const quantity = itemRow.querySelector('.item-quantity').value;
            const discount = itemRow.querySelector('.item-discount').value;
            
            if (!productIndex || !quantity || quantity <= 0) {
                alert('الرجاء إدخال بيانات صحيحة للصنف');
                return;
            }
            
            const product = products[productIndex];
            const price = product.price;
            const totalBeforeDiscount = price * quantity;
            const discountAmount = totalBeforeDiscount * (discount / 100);
            const totalAfterDiscount = totalBeforeDiscount - discountAmount;
            
            currentInvoiceItems.push({
                productId: productIndex,
                productName: product.name,
                quantity: parseInt(quantity),
                price: price,
                discount: parseFloat(discount),
                discountAmount: discountAmount,
                totalBeforeDiscount: totalBeforeDiscount,
                totalAfterDiscount: totalAfterDiscount
            });
            
            renderInvoiceItems();
            calculateInvoiceTotals();
            
            // إعادة تعيين حقول الإدخال
            itemRow.querySelector('.item-product').value = '';
            itemRow.querySelector('.item-quantity').value = '1';
            itemRow.querySelector('.item-price').value = '';
            itemRow.querySelector('.item-discount').value = '0';
        }
        
        // عرض أصناف الفاتورة
        function renderInvoiceItems() {
            const container = document.getElementById('invoiceItems');
            
            // حذف كل الصفوف ما عدا الصف الأول (صف الإضافة)
            const rows = container.querySelectorAll('.grid');
            for (let i = 1; i < rows.length; i++) {
                rows[i].remove();
            }
            
            // إضافة أصناف الفاتورة
            currentInvoiceItems.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 gap-2 items-center';
                row.innerHTML = `
                    <div class="col-span-5">
                        <div class="flex items-center">
                            <span class="mr-2">${item.productName}</span>
                        </div>
                    </div>
                    <div class="col-span-2">
                        <span>${item.quantity}</span>
                    </div>
                    <div class="col-span-2">
                        <span>${item.price.toFixed(2)} دج</span>
                    </div>
                    <div class="col-span-2">
                        <span>${item.discount}% (${item.discountAmount.toFixed(2)} دج)</span>
                    </div>
                    <div class="col-span-1">
                        <button type="button" onclick="removeInvoiceItem(${index})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(row);
            });
        }
        
        // حذف صنف من الفاتورة
        function removeInvoiceItem(index) {
            currentInvoiceItems.splice(index, 1);
            renderInvoiceItems();
            calculateInvoiceTotals();
        }
        
        // حساب إجماليات الفاتورة
        function calculateInvoiceTotals() {
            let subtotal = 0;
            let totalDiscount = 0;
            
            currentInvoiceItems.forEach(item => {
                subtotal += item.totalBeforeDiscount;
                totalDiscount += item.discountAmount;
            });
            
            const grandTotal = subtotal - totalDiscount;
            
            document.getElementById('subtotalAmount').textContent = subtotal.toFixed(2) + ' دج';
            document.getElementById('totalDiscountAmount').textContent = totalDiscount.toFixed(2) + ' دج';
            document.getElementById('grandTotalAmount').textContent = grandTotal.toFixed(2) + ' دج';
        }
        
        // إنشاء فاتورة جديدة
        function createInvoice() {
            if (currentInvoiceItems.length === 0) {
                alert('الرجاء إضافة أصناف إلى الفاتورة');
                return;
            }
            
            const customerName = document.getElementById('customerName').value.trim();
            if (!customerName) {
                alert('الرجاء إدخال اسم العميل');
                return;
            }
            
            const invoiceDate = document.getElementById('invoiceDate').value;
            const notes = document.getElementById('invoiceNotes').value;
            
            const subtotal = currentInvoiceItems.reduce((sum, item) => sum + item.totalBeforeDiscount, 0);
            const totalDiscount = currentInvoiceItems.reduce((sum, item) => sum + item.discountAmount, 0);
            const totalAfterDiscount = subtotal - totalDiscount;
            
            const newInvoice = {
                id: invoices.length > 0 ? Math.max(...invoices.map(i => i.id)) + 1 : 1,
                customerName: customerName,
                issueDate: new Date(invoiceDate).toLocaleDateString('ar-DZ', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                notes: notes,
                items: [...currentInvoiceItems],
                subtotal: subtotal,
                totalDiscount: totalDiscount,
                totalAfterDiscount: totalAfterDiscount
            };
            
            invoices.unshift(newInvoice);
            saveData();
            
            // إعادة تعيين النموذج
            document.getElementById('invoiceForm').reset();
            currentInvoiceItems = [];
            renderInvoiceItems();
            calculateInvoiceTotals();
            
            // تحديث البيانات
            loadInvoices();
            updateReports();
            
            // عرض الفاتورة الجديدة
            viewInvoice(0);
        }
        
        // عرض تفاصيل الفاتورة
        function viewInvoice(index) {
            const invoice = invoices[index];
            currentInvoiceId = index;
            
            document.getElementById('modalInvoiceId').textContent = invoice.id;
            
            let itemsHtml = '';
            invoice.items.forEach((item, i) => {
                itemsHtml += `
                    <tr>
                        <td class="p-2">${i + 1}</td>
                        <td class="p-2">${item.productName}</td>
                        <td class="p-2">${item.quantity}</td>
                        <td class="p-2">${item.price.toFixed(2)} دج</td>
                        <td class="p-2">${item.discount}% (${item.discountAmount.toFixed(2)} دج)</td>
                        <td class="p-2">${item.totalAfterDiscount.toFixed(2)} دج</td>
                    </tr>
                `;
            });
            
            const invoiceHtml = `
                <div class="space-y-6">
                    <!-- معلومات الفاتورة -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">معلومات الفاتورة</h4>
                            <p><span class="text-gray-600">رقم الفاتورة:</span> ${invoice.id}</p>
                            <p><span class="text-gray-600">التاريخ:</span> ${invoice.issueDate}</p>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">معلومات العميل</h4>
                            <p><span class="text-gray-600">الاسم:</span> ${invoice.customerName}</p>
                        </div>
                    </div>
                    
                    <!-- أصناف الفاتورة -->
                    <div>
                        <h4 class="font-bold mb-2">أصناف الفاتورة</h4>
                        <table class="w-full border-collapse invoice-table">
                            <thead>
                                <tr>
                                    <th class="p-2">#</th>
                                    <th class="p-2">المنتج</th>
                                    <th class="p-2">الكمية</th>
                                    <th class="p-2">سعر الوحدة</th>
                                    <th class="p-2">الخصم</th>
                                    <th class="p-2">المجموع</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- الملخص المالي -->
                    <div class="bg-gray-50 p-4 rounded-lg invoice-totals">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-right">
                                <p class="font-bold">المجموع الفرعي:</p>
                            </div>
                            <div class="text-left">
                                <p>${invoice.subtotal.toFixed(2)} دج</p>
                            </div>
                            
                            <div class="text-right">
                                <p class="font-bold text-red-600">إجمالي الخصم:</p>
                            </div>
                            <div class="text-left">
                                <p class="text-red-600">-${invoice.totalDiscount.toFixed(2)} دج</p>
                            </div>
                            
                            <div class="text-right border-t pt-2">
                                <p class="font-bold text-lg">المبلغ الإجمالي:</p>
                            </div>
                            <div class="text-left border-t pt-2">
                                <p class="font-bold text-lg text-blue-600">${invoice.totalAfterDiscount.toFixed(2)} دج</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- الملاحظات -->
                    ${invoice.notes ? `
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-bold mb-2">ملاحظات</h4>
                        <p>${invoice.notes}</p>
                    </div>
                    ` : ''}
                    
                    <!-- التوقيع -->
                    <div class="flex justify-between items-center mt-6">
                        <div class="signature">
                            <p>توقيع العميل:</p>
                            <div class="signature-line"></div>
                        </div>
                        <div class="signature">
                            <p>توقيع المسؤول:</p>
                            <div class="signature-line"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('invoiceDetails').innerHTML = invoiceHtml;
            document.getElementById('invoiceModal').classList.remove('hidden');
        }
        
        // طباعة الفاتورة
        function printInvoice() {
            const invoice = invoices[currentInvoiceId];
            const itemsHtml = invoice.items.map((item, i) => `
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${i + 1}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${item.productName}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.quantity}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${item.price.toFixed(2)} دج</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${item.discount}% (${item.discountAmount.toFixed(2)} دج)</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${item.totalAfterDiscount.toFixed(2)} دج</td>
                </tr>
            `).join('');
            
            const printContent = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>فاتورة #${invoice.id}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
                        body {
                            font-family: 'Tajawal', sans-serif;
                            background-color: white;
                            color: #111827;
                            padding: 1cm;
                        }
                        .container {
                            max-width: 100%;
                            margin: 0 auto;
                            position: relative;
                        }
                        .invoice-header {
                            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                            color: white;
                            padding: 1.5rem;
                            border-radius: 0.5rem 0.5rem 0 0;
                            margin-bottom: 1.5rem;
                        }
                        .invoice-title {
                            font-size: 1.875rem;
                            font-weight: 700;
                            margin: 0;
                        }
                        .invoice-subtitle {
                            font-size: 1.25rem;
                            opacity: 0.9;
                            margin: 0.5rem 0 0 0;
                        }
                        .header-details {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 2rem;
                        }
                        .company-info {
                            flex: 1;
                        }
                        .company-logo {
                            max-height: 100px;
                            margin-left: 2rem;
                        }
                        .invoice-info {
                            flex: 1;
                            text-align: left;
                        }
                        .info-grid {
                            display: grid;
                            grid-template-columns: auto 1fr;
                            gap: 0.75rem;
                        }
                        .info-label {
                            font-weight: 600;
                            color: #4b5563;
                        }
                        .info-value {
                            font-weight: 500;
                        }
                        .invoice-watermark {
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            opacity: 0.05;
                            font-size: 15rem;
                            font-weight: bold;
                            color: #1e40af;
                            z-index: -1;
                            white-space: nowrap;
                        }
                        .invoice-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 1.5rem 0;
                        }
                        .invoice-table th {
                            background-color: #f3f4f6;
                            font-weight: 700;
                            padding: 0.75rem;
                            text-align: right;
                            border: 1px solid #ddd;
                        }
                        .invoice-table td {
                            padding: 0.75rem;
                            border: 1px solid #ddd;
                            text-align: right;
                        }
                        .invoice-totals {
                            background-color: #f9fafb;
                            border-radius: 0.5rem;
                            padding: 1rem;
                            margin-top: 1.5rem;
                            width: 300px;
                            margin-left: auto;
                        }
                        .total-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 0.5rem;
                        }
                        .total-label {
                            font-weight: 600;
                        }
                        .total-value {
                            font-weight: 600;
                        }
                        .grand-total {
                            font-size: 1.25rem;
                            font-weight: 700;
                            color: #1e40af;
                            border-top: 1px solid #e5e7eb;
                            padding-top: 0.5rem;
                            margin-top: 0.5rem;
                        }
                        .invoice-footer {
                            margin-top: 3rem;
                            padding-top: 1.5rem;
                            border-top: 1px dashed #d1d5db;
                            text-align: center;
                        }
                        .footer-text {
                            color: #6b7280;
                            margin-bottom: 0.5rem;
                        }
                        .stamp {
                            position: absolute;
                            right: 50px;
                            bottom: 100px;
                            opacity: 0.8;
                            transform: rotate(15deg);
                            max-width: 150px;
                        }
                        .signature {
                            margin-top: 2rem;
                            text-align: left;
                        }
                        .signature-line {
                            width: 200px;
                            border-top: 1px solid #111827;
                            margin-top: 0.5rem;
                        }
                        @media print {
                            body {
                                padding: 0;
                                font-size: 12pt;
                                line-height: 1.5;
                                color: #000;
                                background-color: #fff;
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                                margin: 0;
                            }
                            .container {
                                padding: 0.5cm;
                            }
                            .no-print {
                                display: none !important;
                            }
                            .invoice-header {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <!-- العلامة المائية -->
                        <div class="invoice-watermark no-print">vellora boutique</div>
                        
                        <!-- رأس الفاتورة -->
                        <div class="invoice-header">
                            <h1 class="invoice-title">فاتورة بيع</h1>
                            <p class="invoice-subtitle">فاتورة رقم #${invoice.id}</p>
                        </div>
                        
                        <!-- معلومات الشركة والفاتورة -->
                        <div class="header-details">
                            <div class="company-info">
                                <h2 class="text-xl font-bold mb-2">Vellora Boutique</h2>
                                <p class="mb-1">باتنة  - بوعقال</p>
                                <p class="mb-1">بجانب الامن الحضري الاول بوعقال</p>
                                <p class="mb-1">الهاتف: 0662411231</p>
                                <p class="mb-1">الانستقرام :vellora_boutique</p>
                            </div>
                            
                            <img src="image.jpg.jpg" class="company-logo no-print">
                            
                            <div class="invoice-info">
                                <div class="info-grid">
                                    <span class="info-label">رقم الفاتورة:</span>
                                    <span class="info-value">${invoice.id}</span>
                                    
                                    <span class="info-label">تاريخ الفاتورة:</span>
                                    <span class="info-value">${invoice.issueDate}</span>
                                    
                                    <span class="info-label">اسم العميل:</span>
                                    <span class="info-value">${invoice.customerName}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- جدول المنتجات -->
                        <table class="invoice-table">
                            <thead>
                                <tr>
                                    <th style="width: 5%;">#</th>
                                    <th style="width: 35%;">المنتج / الخدمة</th>
                                    <th style="width: 10%;">الكمية</th>
                                    <th style="width: 15%;">سعر الوحدة</th>
                                    <th style="width: 15%;">الخصم</th>
                                    <th style="width: 20%;">المجموع</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>
                        
                        <!-- الملخص المالي -->
                        <div class="invoice-totals">
                            <div class="total-row">
                                <span class="total-label">المجموع الفرعي:</span>
                                <span class="total-value">${invoice.subtotal.toFixed(2)} دج</span>
                            </div>
                            <div class="total-row" style="color: #dc2626;">
                                <span class="total-label">الخصم:</span>
                                <span class="total-value">-${invoice.totalDiscount.toFixed(2)} دج</span>
                            </div>
                            <div class="total-row grand-total">
                                <span class="total-label">المبلغ الإجمالي:</span>
                                <span class="total-value">${invoice.totalAfterDiscount.toFixed(2)} دج</span>
                            </div>
                        </div>
                        
                        <!-- ملاحظات الفاتورة -->
                        ${invoice.notes ? `
                        <div style="margin-top: 1.5rem;">
                            <h3 class="text-lg font-bold mb-2">ملاحظات:</h3>
                            <p>${invoice.notes}</p>
                        </div>
                        ` : ''}
                        
                        <!-- التوقيع والختم -->
                        <div style="position: relative; margin-top: 3rem;">
                            <div class="signature">
                                <p>التوقيع:</p>
                                <div class="signature-line"></div>
                                <p style="margin-top: 0.5rem;">مدير المبيعات: مهدي</p>
                            </div>
                            <img src="image.jpg.jpg" alt="ختم الشركة" class="stamp no-print">
                        </div>
                        
                        <!-- تذييل الفاتورة -->
                        <div class="invoice-footer">
                            <p class="footer-text">شكراً لثقتكم بنا</p>
                            <p class="footer-text">للاستفسار يرجى الاتصال على: 0662411231</p>
                            <p class="footer-text">زورونا على صفحتنا على الانستقرام :vellora_boutique</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const win = window.open('', '_blank');
            win.document.write(printContent);
            win.document.close();
            
            // تأخير الطباعة لضمان تحميل الصور
            setTimeout(() => {
                win.print();
            }, 500);
        }
        
        // إضافة منتج جديد
        function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const quantity = parseInt(document.getElementById('productQuantity').value);
            
            if (!name || isNaN(price) || isNaN(quantity)) {
                alert('الرجاء إدخال بيانات صحيحة');
                return;
            }
            
            const newProduct = {
                id: products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1,
                name,
                price,
                quantity
            };
            
            products.push(newProduct);
            saveData();
            
            // إعادة تحميل البيانات
            loadProducts();
            document.getElementById('productForm').reset();
            
            // عرض رسالة نجاح
            alert('تم إضافة المنتج بنجاح');
        }
        
        // عرض تفاصيل المنتج
        function viewProduct(index) {
            const product = products[index];
            document.getElementById('productDetails').innerHTML = `
                <div class="space-y-4">
                    <h4 class="text-xl font-bold">${product.name}</h4>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-gray-600">السعر:</p>
                            <p>${product.price.toFixed(2)} دج</p>
                        </div>
                        <div>
                            <p class="text-gray-600">الكمية المتاحة:</p>
                            <p>${product.quantity}</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-2 space-x-reverse mt-4">
                        <button onclick="editProduct(${index})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-edit mr-2"></i>تعديل
                        </button>
                        <button onclick="deleteProduct(${index})" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-trash mr-2"></i>حذف
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('productModal').classList.remove('hidden');
        }
        
        // تعديل منتج
        function editProduct(index) {
            const product = products[index];
            
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productQuantity').value = product.quantity;
            
            // قم بالتمرير إلى قسم المنتجات
            showSection('products');
            document.getElementById('productName').focus();
            
            // يمكنك إضافة منطق لحفظ التعديلات
            alert('يمكنك الآن تعديل المنتج. سيتم تطوير هذه الوظيفة بشكل كامل في الإصدارات القادمة.');
            
            // إغلاق نافذة العرض
            closeProductModal();
        }
        
        // حذف منتج
        function deleteProduct(index) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                products.splice(index, 1);
                saveData();
                loadProducts();
                updateReports();
                alert('تم حذف المنتج بنجاح');
                
                // إغلاق نافذة العرض إذا كانت مفتوحة
                closeProductModal();
            }
        }
        
        // حفظ البيانات في localStorage
        function saveData() {
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('invoices', JSON.stringify(invoices));
        }
        
        // إظهار/إخفاء الأقسام
        function showSection(sectionId) {
            // إخفاء جميع الأقسام
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // إظهار القسم المطلوب
            document.getElementById(sectionId).classList.remove('hidden');
            
            // تحديث التبويبات النشطة
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.classList.remove('active-tab', 'text-blue-600', 'border-blue-600');
                tab.classList.add('text-gray-600', 'hover:text-blue-600');
            });
            
            document.getElementById(`${sectionId}Tab`).classList.add('active-tab', 'text-blue-600', 'border-blue-600');
            document.getElementById(`${sectionId}Tab`).classList.remove('text-gray-600', 'hover:text-blue-600');
        }
        
        // إغلاق النافذة المنبثقة
        function closeModal() {
            document.getElementById('invoiceModal').classList.add('hidden');
        }
        
        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
        }
    </script>
</body>
</html>